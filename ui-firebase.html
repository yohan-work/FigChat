<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Figma Chat Rooms (Firebase)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2c2c2c;
            color: white;
            padding: 16px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .project-info {
            background: #4a90e2;
            color: white;
            padding: 12px 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-info .icon {
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .connection-status {
            padding: 8px 16px;
            font-size: 11px;
            text-align: center;
            background: #e8f5e8;
            color: #2d5a2d;
            border-bottom: 1px solid #d0e8d0;
        }

        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
            border-bottom-color: #ffeaa7;
        }

        .connection-status.error {
            background: #ffe8e8;
            color: #5a2d2d;
            border-bottom-color: #e8d0d0;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #fafafa;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 8px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }

        .message.own {
            background: #4a90e2;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.other {
            background: white;
            border: 1px solid #e0e0e0;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message-header {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .message-content {
            font-size: 13px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 4px;
        }

        .input-container {
            padding: 16px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
            resize: none;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
        }

        .send-button {
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .send-button:hover {
            background: #357abd;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 13px;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-list {
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 16px;
            font-size: 11px;
            color: #666;
        }

        .firebase-status {
            background: #FF6B35;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        ÌîÑÎ°úÏ†ùÌä∏ Ï±ÑÌåÖÎ∞© <span class="firebase-status">‚ö° yhchoi</span>
    </div>
    
    <div class="project-info">
        <div class="icon">üìÅ</div>
        <div id="project-name">ÌîÑÎ°úÏ†ùÌä∏ Î°úÎî© Ï§ë...</div>
    </div>
    
    <div class="connection-status connecting" id="connection-status">
        Firebase Ïó∞Í≤∞ Ï§ë...
    </div>
    
    <div class="user-list" id="user-list">
        Ïò®ÎùºÏù∏ ÏÇ¨Ïö©Ïûê: Í≥ÑÏÇ∞ Ï§ë...
    </div>
    
    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="empty-state">
                <div class="icon">üî•</div>
                <div>[yhyhyhyhcccchoi]<br>Ï≤´ Î≤àÏß∏ Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥Î≥¥ÏÑ∏Ïöî.</div>
            </div>
        </div>
        
        <div class="input-container">
            <textarea 
                id="message-input" 
                class="message-input" 
                placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                rows="1"
                maxlength="500"
            ></textarea>
            <button id="send-button" class="send-button" disabled>
                ‚û§
            </button>
        </div>
    </div>

    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // FirebaseÎ•º Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú ÏÑ§Ï†ï
        window.firebaseModules = {
            initializeApp,
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            orderBy,
            query,
            serverTimestamp
        };
    </script>

    <script>
        // Firebase ÏÑ§Ï†ï - Ïã§Ï†ú ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï
        const firebaseConfig = {
			apiKey: "dummy",
			authDomain: "dummy",
			projectId: "dummy",
			storageBucket: "dummy",
			messagingSenderId: "dummy",
			appId: "dummy",
			measurementId: "dummy"
		};

        class FigmaFirebaseChatApp {
            constructor() {
                this.currentUser = null;
                this.projectInfo = null;
                this.roomId = null;
                this.unsubscribe = null;
                this.onlineUsers = new Set();
                
                this.initializeElements();
                this.setupEventListeners();
                this.initializeFirebase();
            }
            
            initializeElements() {
                this.elements = {
                    projectName: document.getElementById('project-name'),
                    connectionStatus: document.getElementById('connection-status'),
                    userList: document.getElementById('user-list'),
                    messages: document.getElementById('messages'),
                    messageInput: document.getElementById('message-input'),
                    sendButton: document.getElementById('send-button')
                };
            }
            
            setupEventListeners() {
                // Figma ÌîåÎü¨Í∑∏Ïù∏ Î©îÏãúÏßÄ ÏàòÏã†
                window.onmessage = (event) => {
                    const msg = event.data.pluginMessage;
                    if (msg) {
                        this.handleFigmaMessage(msg);
                    }
                };
                
                // Î©îÏãúÏßÄ ÏûÖÎ†• Ïù¥Î≤§Ìä∏
                this.elements.messageInput.addEventListener('input', (e) => {
                    this.handleInputChange(e);
                });
                
                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Ï†ÑÏÜ° Î≤ÑÌäº
                this.elements.sendButton.addEventListener('click', () => {
                    this.sendMessage();
                });
                
                // ÏûêÎèô ÎÜíÏù¥ Ï°∞Ï†à
                this.elements.messageInput.addEventListener('input', () => {
                    this.adjustTextareaHeight();
                });
            }
            
            async initializeFirebase() {
                try {
                    // Firebase Î™®ÎìàÏù¥ Î°úÎìúÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
                    while (!window.firebaseModules) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    const { initializeApp, getFirestore } = window.firebaseModules;
                    
                    // Firebase Ï¥àÍ∏∞Ìôî
                    this.app = initializeApp(firebaseConfig);
                    this.db = getFirestore(this.app);
                    
                    this.updateConnectionStatus('Firebase Ïó∞Í≤∞Îê®', 'connected');
                    console.log('‚úÖ Firebase Ï¥àÍ∏∞Ìôî ÏÑ±Í≥µ!');
                    
                } catch (error) {
                    console.error('‚ùå Firebase Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                    this.enableDemoMode();
                }
            }
            
            enableDemoMode() {
                console.log('Îç∞Î™® Î™®ÎìúÎ°ú Ïã§Ìñâ Ï§ë (Firebase ÏÑ§Ï†ï ÌïÑÏöî)');
                this.updateConnectionStatus('Îç∞Î™® Î™®Îìú - Firebase ÏÑ§Ï†ï ÌïÑÏöî', 'error');
                this.elements.sendButton.disabled = false;
                
                // Îç∞Î™® Î©îÏãúÏßÄ ÌëúÏãú
                setTimeout(() => {
                    this.displayMessage({
                        content: '‚ö†Ô∏è Firebase ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. README.mdÎ•º Ï∞∏Í≥†ÌïòÏó¨ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.',
                        user: { name: 'ÏãúÏä§ÌÖú', id: 'system' },
                        timestamp: new Date().toISOString()
                    });
                }, 1000);
            }
            
            handleFigmaMessage(msg) {
                switch (msg.type) {
                    case 'init':
                        this.currentUser = msg.data.user;
                        this.projectInfo = msg.data;
                        this.roomId = msg.data.fileId || 'default';
                        console.log('üîç Ï±ÑÌåÖÎ∞© ID ÏÑ§Ï†ï:', {
                            fileName: msg.data.fileName,
                            fileId: msg.data.fileId,
                            roomId: this.roomId
                        });
                        this.updateProjectInfo();
                        this.joinRoom();
                        break;
                        
                    case 'file-info':
                        this.projectInfo = msg.data;
                        this.roomId = msg.data.fileId || 'default';
                        console.log('üîç Ï±ÑÌåÖÎ∞© ID ÏóÖÎç∞Ïù¥Ìä∏:', {
                            fileName: msg.data.fileName,
                            fileId: msg.data.fileId,
                            roomId: this.roomId
                        });
                        this.updateProjectInfo();
                        break;
                }
            }
            
            updateProjectInfo() {
                if (this.projectInfo) {
                    const fileName = this.projectInfo.fileName || 'Î¨¥Ï†ú ÌîÑÎ°úÏ†ùÌä∏';
                    const shortRoomId = this.roomId ? this.roomId.substring(0, 8) + '...' : 'N/A';
                    this.elements.projectName.textContent = `${fileName} (ID: ${shortRoomId})`;
                }
            }
            
            async joinRoom() {
                if (!this.db || !this.roomId) return;
                
                try {
                    const { collection, onSnapshot, orderBy, query } = window.firebaseModules;
                    
                    // Ïù¥Ï†Ñ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨
                    if (this.unsubscribe) {
                        this.unsubscribe();
                    }
                    
                    // Î©îÏãúÏßÄ Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
                    const messagesRef = collection(this.db, 'chatRooms', this.roomId, 'messages');
                    const messagesQuery = query(messagesRef, orderBy('timestamp', 'asc'));
                    
                    this.unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') {
                                this.displayMessage(change.doc.data());
                            }
                        });
                    });
                    
                    console.log('‚úÖ Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï ÏôÑÎ£å');
                    
                    // ÏÇ¨Ïö©Ïûê Ïò®ÎùºÏù∏ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    await this.updateOnlineStatus(true);
                    
                    // ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å Ïãú Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
                    window.addEventListener('beforeunload', () => {
                        this.updateOnlineStatus(false);
                    });
                    
                } catch (error) {
                    console.error('‚ùå Î∞© Ï∞∏Í∞Ä Ïò§Î•ò:', error);
                    this.updateConnectionStatus('Ïó∞Í≤∞ Ïò§Î•ò', 'error');
                }
            }
            
            async updateOnlineStatus(isOnline) {
                if (!this.db || !this.currentUser || !this.roomId) return;
                
                try {
                    const userRef = this.db.collection('chatRooms')
                        .doc(this.roomId)
                        .collection('onlineUsers')
                        .doc(this.currentUser.id);
                    
                    if (isOnline) {
                        await userRef.set({
                            name: this.currentUser.name,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        await userRef.delete();
                    }
                } catch (error) {
                    console.error('Ïò®ÎùºÏù∏ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
                }
            }
            
            async sendMessage() {
                const content = this.elements.messageInput.value.trim();
                if (!content) return;
                
                if (!this.db) {
                    // Îç∞Î™® Î™®ÎìúÏóêÏÑúÎäî Î°úÏª¨Ïóê ÌëúÏãúÎßå
                    this.displayMessage({
                        content: content,
                        user: this.currentUser || { name: 'ÏùµÎ™Ö', id: 'demo' },
                        timestamp: new Date().toISOString()
                    });
                    
                    this.elements.messageInput.value = '';
                    this.adjustTextareaHeight();
                    return;
                }
                
                try {
                    const { collection, addDoc, serverTimestamp } = window.firebaseModules;
                    
                    const message = {
                        content: content,
                        user: this.currentUser,
                        timestamp: serverTimestamp(),
                        roomId: this.roomId
                    };
                    
                    const messagesRef = collection(this.db, 'chatRooms', this.roomId, 'messages');
                    await addDoc(messagesRef, message);
                    
                    this.elements.messageInput.value = '';
                    this.adjustTextareaHeight();
                    this.elements.sendButton.disabled = true;
                    
                } catch (error) {
                    console.error('Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïò§Î•ò:', error);
                    this.displayMessage({
                        content: '‚ö†Ô∏è Î©îÏãúÏßÄ Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.',
                        user: { name: 'ÏãúÏä§ÌÖú', id: 'system' },
                        timestamp: new Date().toISOString()
                    });
                }
            }
            
            displayMessage(message) {
                // Îπà ÏÉÅÌÉú Î©îÏãúÏßÄ Ï†úÍ±∞
                const emptyState = this.elements.messages.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                
                const messageElement = document.createElement('div');
                const isOwnMessage = message.user?.id === this.currentUser?.id;
                
                messageElement.className = `message ${isOwnMessage ? 'own' : 'other'}`;
                messageElement.innerHTML = `
                    <div class="message-header">
                        ${message.user?.name || 'ÏùµÎ™Ö'}
                    </div>
                    <div class="message-content">
                        ${this.escapeHtml(message.content)}
                    </div>
                    <div class="message-time">
                        ${this.formatTime(message.timestamp)}
                    </div>
                `;
                
                this.elements.messages.appendChild(messageElement);
                this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
            }
            
            handleInputChange(e) {
                const hasContent = e.target.value.trim().length > 0;
                this.elements.sendButton.disabled = !hasContent;
            }
            
            updateConnectionStatus(message, status) {
                this.elements.connectionStatus.textContent = message;
                this.elements.connectionStatus.className = `connection-status ${status}`;
            }
            
            adjustTextareaHeight() {
                const textarea = this.elements.messageInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            formatTime(timestamp) {
                let date;
                if (timestamp && timestamp.toDate) {
                    date = timestamp.toDate();
                } else {
                    date = new Date(timestamp);
                }
                return date.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }
        
        // Ïï± Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            new FigmaFirebaseChatApp();
        });
    </script>
</body>
</html> 