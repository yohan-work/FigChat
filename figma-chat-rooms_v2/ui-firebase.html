<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Figma Component Chat Rooms (Firebase)</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f5f5;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: #2c2c2c;
        color: white;
        padding: 16px;
        text-align: center;
        font-weight: 600;
        font-size: 14px;
      }

      .project-info {
        background: #4a90e2;
        color: white;
        padding: 12px 16px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .project-info .icon {
        width: 16px;
        height: 16px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .room-selector {
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        padding: 12px 16px;
      }

      .room-selector-label {
        font-size: 11px;
        color: #666;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .room-dropdown {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 12px;
        background: white;
        cursor: pointer;
        outline: none;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      }

      .room-dropdown:focus {
        border-color: #4a90e2;
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
      }

      .room-dropdown option {
        padding: 4px 8px;
        font-size: 12px;
      }

      .current-room {
        background: #e8f4fd;
        color: #2c5a8a;
        padding: 8px 16px;
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid #d0e8f0;
      }

      .current-room .room-type {
        background: rgba(76, 144, 226, 0.2);
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
      }

      .auto-switch-info {
        background: #fff3cd;
        color: #856404;
        padding: 6px 16px;
        font-size: 10px;
        text-align: center;
        border-bottom: 1px solid #ffeaa7;
      }

      .keyboard-shortcut-info {
        background: #e8f4fd;
        color: #2c5a8a;
        padding: 6px 16px;
        font-size: 10px;
        text-align: center;
        border-bottom: 1px solid #d0e8f0;
      }

      .connection-status {
        padding: 8px 16px;
        font-size: 11px;
        text-align: center;
        background: #e8f5e8;
        color: #2d5a2d;
        border-bottom: 1px solid #d0e8d0;
      }

      .connection-status.connecting {
        background: #fff3cd;
        color: #856404;
        border-bottom-color: #ffeaa7;
      }

      .connection-status.error {
        background: #ffe8e8;
        color: #5a2d2d;
        border-bottom-color: #e8d0d0;
      }

      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
      }

      .messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        background: #fafafa;
        display: flex;
        flex-direction: column;
      }

      .message {
        margin-bottom: 12px;
        padding: 12px;
        border-radius: 8px;
        max-width: 85%;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease-in;
      }

      .message.own {
        background: #4a90e2;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }

      .message.other {
        background: white;
        border: 1px solid #e0e0e0;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }

      .message-header {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 4px;
        opacity: 0.8;
      }

      .message-content {
        font-size: 13px;
        line-height: 1.4;
      }

      .message-time {
        font-size: 10px;
        opacity: 0.6;
        margin-top: 4px;
      }

      .input-container {
        padding: 16px;
        background: white;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 8px;
      }

      .message-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 13px;
        outline: none;
        resize: none;
        font-family: inherit;
      }

      .message-input:focus {
        border-color: #4a90e2;
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
      }

      .send-button {
        background: #4a90e2;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }

      .send-button:hover {
        background: #357abd;
      }

      .send-button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
        font-size: 13px;
      }

      .empty-state .icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.3;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .user-list {
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        padding: 8px 16px;
        font-size: 11px;
        color: #666;
      }

      .firebase-status {
        background: #ff6b35;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
      }

      .badge-controls {
        padding: 8px 16px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
      }

      .badge-control-btn {
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 500;
        transition: background 0.2s;
        color: white;
      }

      .badge-control-btn.create-btn {
        background: #4a90e2;
      }

      .badge-control-btn.create-btn:hover:not(:disabled) {
        background: #357abd;
      }

      .badge-control-btn.remove-btn {
        background: #ff6b35;
      }

      .badge-control-btn.remove-btn:hover:not(:disabled) {
        background: #e85a2b;
      }

      .badge-control-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="header">
      ì»´í¬ë„ŒíŠ¸ë³„ ì±„íŒ…ë°© <span class="firebase-status">âš¡ yhchoi</span>
    </div>

    <div class="project-info">
      <div class="icon">ğŸ“</div>
      <div id="project-name">í”„ë¡œì íŠ¸ ë¡œë”© ì¤‘...</div>
    </div>

    <div class="room-selector">
      <div class="room-selector-label">ì±„íŒ…ë°© ì„ íƒ</div>
      <select id="room-dropdown" class="room-dropdown">
        <option value="">ë¡œë”© ì¤‘...</option>
      </select>
    </div>

    <div class="current-room" id="current-room">
      <div class="room-type" id="room-type">ì „ì²´</div>
      <div id="current-room-name">ì „ì²´ í”„ë¡œì íŠ¸</div>
    </div>

    <div class="auto-switch-info" id="auto-switch-info" style="display: none">
      ğŸ’¡ ì»´í¬ë„ŒíŠ¸ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì±„íŒ…ë°©ìœ¼ë¡œ ìë™ ì „í™˜ë©ë‹ˆë‹¤
    </div>

    <div
      class="keyboard-shortcut-info"
      id="shortcut-info"
      style="display: none"
    >
      âŒ¨ï¸ ë‹¨ì¶•í‚¤: Ctrl+/ â†’ "ì±„íŒ…" ê²€ìƒ‰ | í”ŒëŸ¬ê·¸ì¸ ë‚´: Ctrl+L (ë‹«ê¸°), Ctrl+Enter
      (ì „ì†¡), ESC (ë‹«ê¸°)
    </div>

    <div class="badge-controls" id="badge-controls" style="display: none">
      <button id="create-badges-btn" class="badge-control-btn create-btn">
        ë°°ì§€ ìƒì„±
      </button>
      <button id="remove-badges-btn" class="badge-control-btn remove-btn">
        ë°°ì§€ ì œê±°
      </button>
    </div>

    <div class="connection-status connecting" id="connection-status">
      Firebase ì—°ê²° ì¤‘...
    </div>

    <div class="user-list" id="user-list">ì˜¨ë¼ì¸ ì‚¬ìš©ì: ê³„ì‚° ì¤‘...</div>

    <div class="chat-container">
      <div class="messages" id="messages">
        <div class="empty-state">
          <div class="icon">ğŸ’¬</div>
          <div>ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”.</div>
        </div>
      </div>

      <div class="input-container">
        <textarea
          id="message-input"
          class="message-input"
          placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
          rows="1"
          maxlength="500"
        ></textarea>
        <button id="send-button" class="send-button" disabled>â¤</button>
      </div>
    </div>

    <!-- Firebase SDK v9 -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        orderBy,
        query,
        serverTimestamp,
        doc,
        setDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Firebaseë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
      window.firebaseModules = {
        initializeApp,
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        orderBy,
        query,
        serverTimestamp,
        doc,
        setDoc,
        deleteDoc,
      };
    </script>

    <script>
      // Firebase ì„¤ì • - ì‹¤ì œ í”„ë¡œì íŠ¸ ì„¤ì •
      const firebaseConfig = {};

      class FigmaFirebaseChatApp {
        constructor() {
          this.currentUser = null;
          this.projectInfo = null;
          this.roomId = null;
          this.unsubscribe = null;
          this.onlineUsers = new Set();
          this.availableComponents = [];
          this.currentComponent = null;
          this.beforeUnloadRegistered = false;
          this.roomMessageCounts = new Map(); // ê° ë°©ì˜ ë©”ì‹œì§€ ê°œìˆ˜ ì €ì¥
          this.roomCountListeners = new Map(); // ê° ë°©ì˜ ì¹´ìš´íŠ¸ ë¦¬ìŠ¤ë„ˆ ì €ì¥
          this.isRoomTransitioning = false; // ë°© ì „í™˜ ì¤‘ ìƒíƒœ ì¶”ì 

          this.initializeElements();
          this.setupEventListeners();
          this.initializeFirebase();
        }

        initializeElements() {
          this.elements = {
            projectName: document.getElementById("project-name"),
            connectionStatus: document.getElementById("connection-status"),
            userList: document.getElementById("user-list"),
            messages: document.getElementById("messages"),
            messageInput: document.getElementById("message-input"),
            sendButton: document.getElementById("send-button"),
            roomDropdown: document.getElementById("room-dropdown"),
            currentRoom: document.getElementById("current-room"),
            roomType: document.getElementById("room-type"),
            currentRoomName: document.getElementById("current-room-name"),
            autoSwitchInfo: document.getElementById("auto-switch-info"),
          };
        }

        setupEventListeners() {
          // Figma í”ŒëŸ¬ê·¸ì¸ ë©”ì‹œì§€ ìˆ˜ì‹ 
          window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (msg) {
              this.handleFigmaMessage(msg);
            }
          };

          // ë©”ì‹œì§€ ì…ë ¥ ì´ë²¤íŠ¸
          this.elements.messageInput.addEventListener("input", (e) => {
            this.handleInputChange(e);
          });

          this.elements.messageInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              this.sendMessage();
            }
          });

          // ì „ì—­ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (í”ŒëŸ¬ê·¸ì¸ ë‚´ë¶€ì—ì„œë§Œ ì‘ë™)
          document.addEventListener("keydown", (e) => {
            // Ctrl+L ë˜ëŠ” Cmd+Lë¡œ í”ŒëŸ¬ê·¸ì¸ ë‹«ê¸°
            if ((e.ctrlKey || e.metaKey) && e.key === "l") {
              e.preventDefault();
              console.log("ğŸ¹ ë‹¨ì¶•í‚¤ ê°ì§€: Ctrl/Cmd + L - í”ŒëŸ¬ê·¸ì¸ ë‹«ê¸°");
              this.closePlugin();
            }
            // Escapeë¡œ í”ŒëŸ¬ê·¸ì¸ ë‹«ê¸°
            if (e.key === "Escape") {
              e.preventDefault();
              console.log("ğŸ¹ ë‹¨ì¶•í‚¤ ê°ì§€: Escape - í”ŒëŸ¬ê·¸ì¸ ë‹«ê¸°");
              this.closePlugin();
            }
            // Ctrl+Enter ë˜ëŠ” Cmd+Enterë¡œ ë©”ì‹œì§€ ì „ì†¡
            if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
              e.preventDefault();
              console.log("ğŸ¹ ë‹¨ì¶•í‚¤ ê°ì§€: Ctrl/Cmd + Enter - ë©”ì‹œì§€ ì „ì†¡");
              this.sendMessage();
            }
          });

          // ì „ì†¡ ë²„íŠ¼
          this.elements.sendButton.addEventListener("click", () => {
            this.sendMessage();
          });

          // ìë™ ë†’ì´ ì¡°ì ˆ
          this.elements.messageInput.addEventListener("input", () => {
            this.adjustTextareaHeight();
          });

          // ì±„íŒ…ë°© ì„ íƒ ì´ë²¤íŠ¸
          this.elements.roomDropdown.addEventListener("change", () => {
            this.handleRoomChange();
          });

          // ë°°ì§€ ì œê±° ë²„íŠ¼ ì´ë²¤íŠ¸
          const removeBadgesBtn = document.getElementById("remove-badges-btn");
          if (removeBadgesBtn) {
            removeBadgesBtn.addEventListener("click", () => {
              this.removeAllFigmaBadges();
            });
          }

          // ë°°ì§€ ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸
          const createBadgesBtn = document.getElementById("create-badges-btn");
          if (createBadgesBtn) {
            createBadgesBtn.addEventListener("click", () => {
              this.createFigmaBadges();
            });
          }
        }

        async handleRoomChange() {
          const selectedComponentId = this.elements.roomDropdown.value;
          if (!selectedComponentId) return;

          // Figma í”ŒëŸ¬ê·¸ì¸ì— ë°© ë³€ê²½ ìš”ì²­
          parent.postMessage(
            {
              pluginMessage: {
                type: "switch-room",
                componentId: selectedComponentId,
                componentName:
                  this.elements.roomDropdown.options[
                    this.elements.roomDropdown.selectedIndex
                  ].text,
              },
            },
            "*"
          );
        }

        closePlugin() {
          // ëª¨ë“  ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
          if (this.unsubscribe) {
            this.unsubscribe();
            this.unsubscribe = null;
          }

          this.roomCountListeners.forEach((unsubscribe) => unsubscribe());
          this.roomCountListeners.clear();

          // Figma í”ŒëŸ¬ê·¸ì¸ ë‹«ê¸° ìš”ì²­
          parent.postMessage(
            {
              pluginMessage: {
                type: "close-plugin",
              },
            },
            "*"
          );
        }

        async initializeFirebase() {
          try {
            // Firebase ëª¨ë“ˆì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            while (!window.firebaseModules) {
              await new Promise((resolve) => setTimeout(resolve, 100));
            }

            const { initializeApp, getFirestore } = window.firebaseModules;

            // Firebase ì´ˆê¸°í™”
            this.app = initializeApp(firebaseConfig);
            this.db = getFirestore(this.app);

            this.updateConnectionStatus("Firebase ì—°ê²°ë¨", "connected");
            console.log("âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ!");
          } catch (error) {
            console.error("âŒ Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
            this.enableDemoMode();
          }
        }

        enableDemoMode() {
          console.log("ë°ëª¨ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ (Firebase ì„¤ì • í•„ìš”)");
          this.updateConnectionStatus(
            "ë°ëª¨ ëª¨ë“œ - Firebase ì„¤ì • í•„ìš”",
            "error"
          );
          this.elements.sendButton.disabled = false;

          // ë°ëª¨ ë©”ì‹œì§€ í‘œì‹œ
          setTimeout(() => {
            this.displayMessage({
              content:
                "âš ï¸ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. README.mdë¥¼ ì°¸ê³ í•˜ì—¬ ì„¤ì •í•´ì£¼ì„¸ìš”.",
              user: { name: "ì‹œìŠ¤í…œ", id: "system" },
              timestamp: new Date().toISOString(),
            });
          }, 1000);
        }

        handleFigmaMessage(msg) {
          switch (msg.type) {
            case "init":
              this.currentUser = msg.data.user;
              this.projectInfo = msg.data;
              this.roomId = msg.data.fileId || "default";
              this.availableComponents = msg.data.availableComponents || [];
              this.currentComponent = msg.data.selectedComponent;

              console.log("ğŸ” ì±„íŒ…ë°© ID ì„¤ì •:", {
                fileName: msg.data.fileName,
                fileId: msg.data.fileId,
                roomId: this.roomId,
                selectedComponent: this.currentComponent,
                availableComponents: this.availableComponents,
              });

              this.updateRoomDropdown();
              this.updateCurrentRoom();
              this.updateProjectInfo();
              this.joinRoom();

              // Firebase ì´ˆê¸°í™”ê°€ ì™„ë£Œëœ í›„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
              setTimeout(() => {
                this.setupRoomCountListeners(); // ëª¨ë“  ë°©ì˜ ë©”ì‹œì§€ ê°œìˆ˜ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
              }, 1000);

              this.elements.autoSwitchInfo.style.display = "block";

              // ë°°ì§€ ì»¨íŠ¸ë¡¤ í‘œì‹œ
              const badgeControls = document.getElementById("badge-controls");
              if (badgeControls) {
                badgeControls.style.display = "flex";
              }

              // ë‹¨ì¶•í‚¤ ì •ë³´ í‘œì‹œ (5ì´ˆ í›„ ìë™ ìˆ¨ê¹€)
              const shortcutInfo = document.getElementById("shortcut-info");
              if (shortcutInfo) {
                shortcutInfo.style.display = "block";
                setTimeout(() => {
                  shortcutInfo.style.display = "none";
                }, 5000);
              }
              break;

            case "selection-changed":
              console.log("ğŸ“¨ ì„ íƒ ë³€ê²½ ë©”ì‹œì§€ ë°›ìŒ:", msg.data);

              const previousRoomId = this.roomId;
              const previousComponent = this.currentComponent;

              // ìƒˆë¡œìš´ ì»´í¬ë„ŒíŠ¸ ì •ë³´ ë¨¼ì € ì„¤ì •
              this.currentComponent = msg.data.selectedComponent;

              console.log("ğŸ”„ ì„ íƒ ë³€ê²½:", {
                previousRoomId: previousRoomId,
                newRoomId: msg.data.roomId,
                previousComponent: previousComponent,
                selectedComponent: this.currentComponent,
                shouldSwitch: previousRoomId !== msg.data.roomId,
              });

              this.updateCurrentRoom();
              this.updateDropdownSelection();

              // í˜„ì¬ ë°© ì •ë³´ ê°•ì œ ì—…ë°ì´íŠ¸ (ì»´í¬ë„ŒíŠ¸ê°€ ë³€ê²½ëœ ê²½ìš°)
              if (previousComponent?.id !== this.currentComponent?.id) {
                console.log("ğŸ”„ ì»´í¬ë„ŒíŠ¸ ë³€ê²½ë¨ - ë°© ì •ë³´ ê°•ì œ ì—…ë°ì´íŠ¸");
                this.updateCurrentRoomInfo();
              }

              // ì‹¤ì œë¡œ ë°©ì´ ë‹¤ë¥¼ ë•Œë§Œ ì „í™˜ (roomIdëŠ” switchToRoomì—ì„œ ì—…ë°ì´íŠ¸)
              if (previousRoomId !== msg.data.roomId) {
                console.log("ğŸš€ ì±„íŒ…ë°© ì „í™˜ ì‹œì‘...");
                this.switchToRoom(msg.data.roomId);
              } else {
                console.log("â„¹ï¸ ë™ì¼í•œ ì±„íŒ…ë°©ì´ë¯€ë¡œ ì „í™˜í•˜ì§€ ì•ŠìŒ");
              }
              break;

            case "room-switched":
              this.roomId = msg.data.roomId;
              console.log("ğŸ  ë°© ë³€ê²½ë¨:", msg.data);
              this.switchToRoom(this.roomId);
              break;

            case "file-info":
              this.projectInfo = msg.data;
              this.roomId = msg.data.fileId || "default";
              this.availableComponents = msg.data.availableComponents || [];

              console.log("ğŸ” ì±„íŒ…ë°© ID ì—…ë°ì´íŠ¸:", {
                fileName: msg.data.fileName,
                fileId: msg.data.fileId,
                roomId: this.roomId,
              });

              this.updateRoomDropdown();
              this.updateProjectInfo();
              break;
          }
        }

        updateProjectInfo() {
          if (this.projectInfo) {
            const fileName = this.projectInfo.fileName || "ë¬´ì œ í”„ë¡œì íŠ¸";
            const shortRoomId = this.roomId
              ? this.roomId.substring(0, 8) + "..."
              : "N/A";
            this.elements.projectName.textContent = `${fileName} (ID: ${shortRoomId})`;
          }
        }

        updateRoomDropdown() {
          console.log("ğŸ”„ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì‹œì‘", {
            availableComponentsCount: this.availableComponents.length,
            roomMessageCountsSize: this.roomMessageCounts.size,
            allCounts: Array.from(this.roomMessageCounts.entries()),
          });

          this.elements.roomDropdown.innerHTML = "";

          this.availableComponents.forEach((component) => {
            const option = document.createElement("option");
            option.value = component.id;

            // ë©”ì‹œì§€ ê°œìˆ˜ í‘œì‹œ
            const messageCount = this.roomMessageCounts.get(component.id) || 0;
            const countDisplay = messageCount > 0 ? ` (${messageCount})` : "";
            const activeIndicator = messageCount > 0 ? "ğŸ’¬ " : "ğŸ“­ ";

            option.textContent = `${activeIndicator}${component.name}${countDisplay}`;

            console.log(`ğŸ“‹ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ìƒì„±: ${component.name}`, {
              componentId: component.id,
              messageCount: messageCount,
              displayText: option.textContent,
            });

            if (
              this.currentComponent &&
              component.id === this.currentComponent.id
            ) {
              option.selected = true;
            }

            this.elements.roomDropdown.appendChild(option);
          });

          console.log("âœ… ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
        }

        updateDropdownSelection() {
          if (this.currentComponent) {
            this.elements.roomDropdown.value = this.currentComponent.id;
          }
        }

        updateCurrentRoom() {
          if (this.currentComponent) {
            const typeMap = {
              general: "ì „ì²´",
              component: "ì»´í¬ë„ŒíŠ¸",
              instance: "ì¸ìŠ¤í„´ìŠ¤",
              nested: "ì¤‘ì²©",
              layer: "ë ˆì´ì–´",
              frame: "í”„ë ˆì„",
            };

            this.elements.roomType.textContent =
              typeMap[this.currentComponent.type] || this.currentComponent.type;

            // ë©”ì‹œì§€ ê°œìˆ˜ í¬í•¨í•œ ë°© ì •ë³´ ì—…ë°ì´íŠ¸
            this.updateCurrentRoomInfo();

            // ì„ì‹œ: ë©”ì‹œì§€ ì…ë ¥ì°½ placeholder ì—…ë°ì´íŠ¸
            this.elements.messageInput.placeholder = `${this.currentComponent.name}ì—ì„œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...`;

            console.log("ğŸ  í˜„ì¬ ë°© ì •ë³´ ì—…ë°ì´íŠ¸:", {
              type: this.currentComponent.type,
              name: this.currentComponent.name,
              roomId: this.roomId,
            });
          }
        }

        async switchToRoom(newRoomId) {
          // í˜„ì¬ ë°©ê³¼ ê°™ì€ ë°©ìœ¼ë¡œ ì „í™˜í•˜ë ¤ëŠ” ê²½ìš° ì¤‘ë‹¨
          if (newRoomId === this.roomId) {
            console.log("âš ï¸ ë™ì¼í•œ ë°©ìœ¼ë¡œ ì „í™˜ ì‹œë„ - ì¤‘ë‹¨:", newRoomId);
            return;
          }

          // ì´ë¯¸ ë°© ì „í™˜ ì¤‘ì¸ ê²½ìš° ì¤‘ë‹¨
          if (this.isRoomTransitioning) {
            console.log("âš ï¸ ì´ë¯¸ ë°© ì „í™˜ ì¤‘ - ì¤‘ë‹¨:", newRoomId);
            return;
          }

          this.isRoomTransitioning = true;
          console.log("ğŸ”„ ì±„íŒ…ë°© ì „í™˜:", { from: this.roomId, to: newRoomId });

          try {
            // ì´ì „ ë¦¬ìŠ¤ë„ˆ ì™„ì „íˆ ì •ë¦¬
            console.log("ğŸ§¹ ì´ì „ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ ì¤‘...");
            if (this.unsubscribe) {
              this.unsubscribe();
              this.unsubscribe = null;
              console.log("âœ… ì´ì „ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ ì™„ë£Œ");
            }

            // roomId ì—…ë°ì´íŠ¸ëŠ” ì—¬ê¸°ì„œ
            this.roomId = newRoomId;
            console.log("ğŸ“ ìƒˆ roomId ì„¤ì •:", this.roomId);

            // ë©”ì‹œì§€ ì´ˆê¸°í™”
            console.log("ğŸ—‘ï¸ ë©”ì‹œì§€ ì´ˆê¸°í™” ì¤‘...", {
              currentChildrenCount: this.elements.messages.children.length,
              currentRoomId: this.roomId,
            });

            // ê¸°ì¡´ ë©”ì‹œì§€ ì™„ì „íˆ ì œê±°
            while (this.elements.messages.firstChild) {
              this.elements.messages.removeChild(
                this.elements.messages.firstChild
              );
            }

            // ë¹ˆ ìƒíƒœ ì¶”ê°€
            const emptyStateDiv = document.createElement("div");
            emptyStateDiv.className = "empty-state";
            const roomName = this.currentComponent
              ? this.currentComponent.name
              : "ì±„íŒ…ë°©";
            emptyStateDiv.innerHTML = `<div class="icon">ğŸ’¬</div><div>${roomName}ì—ì„œ<br>ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”.</div>`;
            this.elements.messages.appendChild(emptyStateDiv);

            console.log("âœ… ë©”ì‹œì§€ ì´ˆê¸°í™” ì™„ë£Œ", {
              newChildrenCount: this.elements.messages.children.length,
              innerHTML:
                this.elements.messages.innerHTML.substring(0, 100) + "...",
            });

            // ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            console.log("ğŸ”„ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì¤‘...");
            this.updateDropdownSelection();
            console.log("âœ… ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì™„ë£Œ");

            // ìƒˆ ë°© ì°¸ê°€
            console.log("ğŸ  ìƒˆ ë°© ì°¸ê°€ ì‹œì‘...");
            await this.joinRoom();
            console.log("âœ… ìƒˆ ë°© ì°¸ê°€ ì™„ë£Œ");

            console.log("ğŸ‰ ì±„íŒ…ë°© ì „í™˜ ì™„ë£Œ:", this.roomId);
          } catch (error) {
            console.error("âŒ ì±„íŒ…ë°© ì „í™˜ ì—ëŸ¬:", error);
          } finally {
            this.isRoomTransitioning = false;
          }
        }

        // ëª¨ë“  ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ ê°œìˆ˜ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        async setupRoomCountListeners() {
          console.log("ğŸ“Š setupRoomCountListeners í˜¸ì¶œë¨", {
            dbExists: !!this.db,
            availableComponentsLength: this.availableComponents.length,
            availableComponents: this.availableComponents,
          });

          if (!this.db) {
            console.error("âŒ DBê°€ ì—†ì–´ì„œ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë¶ˆê°€");
            return;
          }

          if (!this.availableComponents.length) {
            console.error(
              "âŒ availableComponentsê°€ ë¹„ì–´ìˆì–´ì„œ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë¶ˆê°€"
            );
            return;
          }

          console.log("ğŸ“Š ë©”ì‹œì§€ ê°œìˆ˜ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘");

          try {
            const { collection, onSnapshot, query } = window.firebaseModules;

            // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆë“¤ ì •ë¦¬
            console.log(
              "ğŸ§¹ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ ì¤‘...",
              this.roomCountListeners.size
            );
            this.roomCountListeners.forEach((unsubscribe) => unsubscribe());
            this.roomCountListeners.clear();
            this.roomMessageCounts.clear(); // ê¸°ì¡´ ì¹´ìš´íŠ¸ë„ ì´ˆê¸°í™”

            for (const component of this.availableComponents) {
              const roomId = this.generateRoomIdForComponent(component);

              console.log(`ğŸ“Š ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì¤‘: ${component.name}`, {
                componentId: component.id,
                roomId: roomId,
              });

              const messagesRef = collection(
                this.db,
                "chatRooms",
                roomId,
                "messages"
              );
              const messagesQuery = query(messagesRef);

              const unsubscribe = onSnapshot(
                messagesQuery,
                (snapshot) => {
                  const messageCount = snapshot.size;
                  this.roomMessageCounts.set(component.id, messageCount);

                  console.log(`ğŸ“Š ${component.name} ë©”ì‹œì§€ ê°œìˆ˜ ì—…ë°ì´íŠ¸:`, {
                    componentId: component.id,
                    roomId: roomId,
                    messageCount: messageCount,
                    snapshotSize: snapshot.size,
                    totalCounts: this.roomMessageCounts.size,
                  });

                  // ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
                  this.updateRoomDropdown();

                  // í˜„ì¬ ë°© ì •ë³´ ì—…ë°ì´íŠ¸
                  this.updateCurrentRoomInfo();

                  // ğŸ†• í”¼ê·¸ë§ˆì— ë°°ì§€ ì—…ë°ì´íŠ¸ ìš”ì²­
                  this.updateFigmaChatBadges();
                },
                (error) => {
                  console.error(`âŒ ${component.name} ë¦¬ìŠ¤ë„ˆ ì—ëŸ¬:`, error);
                }
              );

              this.roomCountListeners.set(component.id, unsubscribe);
              console.log(`âœ… ${component.name} ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ`);
            }

            console.log("âœ… ë©”ì‹œì§€ ê°œìˆ˜ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ", {
              totalListeners: this.roomCountListeners.size,
              components: Array.from(this.roomCountListeners.keys()),
            });
          } catch (error) {
            console.error("âŒ ë©”ì‹œì§€ ê°œìˆ˜ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì˜¤ë¥˜:", error);
          }
        }

        // ğŸ†• í”¼ê·¸ë§ˆ ì±„íŒ… ë°°ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        updateFigmaChatBadges() {
          try {
            // ì»´í¬ë„ŒíŠ¸ë³„ ë©”ì‹œì§€ ê°œìˆ˜ë¥¼ ê°ì²´ë¡œ ë³€í™˜
            const componentMessageCounts = {};
            this.roomMessageCounts.forEach((count, componentId) => {
              componentMessageCounts[componentId] = count;
            });

            console.log(
              "ğŸ·ï¸ í”¼ê·¸ë§ˆ ë°°ì§€ ì—…ë°ì´íŠ¸ ìš”ì²­:",
              componentMessageCounts
            );

            // í”¼ê·¸ë§ˆ í”ŒëŸ¬ê·¸ì¸ì— ë°°ì§€ ì—…ë°ì´íŠ¸ ìš”ì²­
            parent.postMessage(
              {
                pluginMessage: {
                  type: "update-chat-badges",
                  data: {
                    componentMessageCounts: componentMessageCounts,
                  },
                },
              },
              "*"
            );
          } catch (error) {
            console.error("âŒ í”¼ê·¸ë§ˆ ë°°ì§€ ì—…ë°ì´íŠ¸ ìš”ì²­ ì˜¤ë¥˜:", error);
          }
        }

        // ğŸ†• ëª¨ë“  í”¼ê·¸ë§ˆ ë°°ì§€ ì œê±° í•¨ìˆ˜
        removeAllFigmaBadges() {
          try {
            console.log("ğŸ·ï¸ ëª¨ë“  ë°°ì§€ ì œê±° ìš”ì²­");

            // í”¼ê·¸ë§ˆ í”ŒëŸ¬ê·¸ì¸ì— ë°°ì§€ ì œê±° ìš”ì²­
            parent.postMessage(
              {
                pluginMessage: {
                  type: "remove-all-badges",
                },
              },
              "*"
            );

            // ì‚¬ìš©ìì—ê²Œ í”¼ë“œë°± ì œê³µ
            const removeBadgesBtn =
              document.getElementById("remove-badges-btn");
            if (removeBadgesBtn) {
              const originalText = removeBadgesBtn.textContent;
              removeBadgesBtn.textContent = "âœ…";
              removeBadgesBtn.disabled = true;

              setTimeout(() => {
                removeBadgesBtn.textContent = originalText;
                removeBadgesBtn.disabled = false;
              }, 2000);
            }
          } catch (error) {
            console.error("âŒ í”¼ê·¸ë§ˆ ë°°ì§€ ì œê±° ìš”ì²­ ì˜¤ë¥˜:", error);
          }
        }

        // ğŸ†• í”¼ê·¸ë§ˆ ë°°ì§€ ìƒì„± í•¨ìˆ˜
        createFigmaBadges() {
          try {
            console.log("ğŸ·ï¸ ë°°ì§€ ìƒì„± ìš”ì²­");

            // í˜„ì¬ ë©”ì‹œì§€ ê°œìˆ˜ ì •ë³´ë¡œ ë°°ì§€ ìƒì„±
            this.updateFigmaChatBadges();

            // ì‚¬ìš©ìì—ê²Œ í”¼ë“œë°± ì œê³µ
            const createBadgesBtn =
              document.getElementById("create-badges-btn");
            if (createBadgesBtn) {
              const originalText = createBadgesBtn.textContent;
              createBadgesBtn.textContent = "âœ…";
              createBadgesBtn.disabled = true;

              setTimeout(() => {
                createBadgesBtn.textContent = originalText;
                createBadgesBtn.disabled = false;
              }, 2000);
            }
          } catch (error) {
            console.error("âŒ í”¼ê·¸ë§ˆ ë°°ì§€ ìƒì„± ìš”ì²­ ì˜¤ë¥˜:", error);
          }
        }

        // ì»´í¬ë„ŒíŠ¸ë¥¼ ìœ„í•œ Room ID ìƒì„±
        generateRoomIdForComponent(component) {
          // code.jsì˜ generateRoomId ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ êµ¬í˜„
          let baseId = "";
          if (
            this.projectInfo?.figmaFileKey &&
            this.projectInfo.figmaFileKey !== ""
          ) {
            baseId = this.projectInfo.figmaFileKey;
          } else {
            const fileName = this.projectInfo?.fileName || "untitled";
            const rootId = this.projectInfo?.rootId || "0:0";
            const cleanFileName = fileName
              .replace(/[^a-zA-Z0-9]/g, "_")
              .toLowerCase();
            baseId = `${cleanFileName}_${rootId}`;
          }

          let roomId;
          if (component.id === "general") {
            roomId = `${baseId}_general`;
          } else {
            roomId = `${baseId}_component_${component.id}`;
          }

          console.log("ğŸ†” Room ID ìƒì„±:", {
            component: component,
            baseId: baseId,
            generatedRoomId: roomId,
            projectInfo: this.projectInfo,
          });

          return roomId;
        }

        // í˜„ì¬ ë°© ì •ë³´ ì—…ë°ì´íŠ¸
        updateCurrentRoomInfo() {
          if (this.currentComponent) {
            const messageCount =
              this.roomMessageCounts.get(this.currentComponent.id) || 0;
            const countDisplay =
              messageCount > 0 ? ` (${messageCount}ê°œ ë©”ì‹œì§€)` : " (ë¹ˆ ì±„íŒ…ë°©)";

            console.log("ğŸ” í˜„ì¬ ë°© ì •ë³´ ë””ë²„ê·¸:", {
              currentComponentId: this.currentComponent.id,
              currentComponentName: this.currentComponent.name,
              messageCount: messageCount,
              allCounts: Array.from(this.roomMessageCounts.entries()),
              currentRoomId: this.roomId,
            });

            // í˜„ì¬ ë°© ì´ë¦„ì— ë©”ì‹œì§€ ê°œìˆ˜ í‘œì‹œ
            this.elements.currentRoomName.textContent =
              this.currentComponent.name + countDisplay;
          }
        }

        async joinRoom() {
          console.log("ğŸ”— joinRoom ë©”ì†Œë“œ ì‹œì‘:", {
            db: !!this.db,
            roomId: this.roomId,
          });

          if (!this.db || !this.roomId) {
            console.log("âŒ joinRoom ì¡°ê±´ ë¶ˆì¶©ì¡±:", {
              db: !!this.db,
              roomId: this.roomId,
            });
            return;
          }

          try {
            console.log("ğŸ“¦ Firebase ëª¨ë“ˆ ë¡œë“œ ì¤‘...");
            const { collection, onSnapshot, orderBy, query } =
              window.firebaseModules;
            console.log("âœ… Firebase ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ");

            // ì´ì „ ë¦¬ìŠ¤ë„ˆ ì™„ì „íˆ ì •ë¦¬
            if (this.unsubscribe) {
              console.log("ğŸ§¹ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ ì¤‘...");
              this.unsubscribe();
              this.unsubscribe = null;
              console.log("âœ… ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ ì™„ë£Œ");
            }

            console.log("ğŸ”— ìƒˆ ì±„íŒ…ë°© ì°¸ê°€:", this.roomId);

            // ë©”ì‹œì§€ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            console.log("ğŸ“‹ ë©”ì‹œì§€ ì¿¼ë¦¬ ìƒì„± ì¤‘...");
            const messagesRef = collection(
              this.db,
              "chatRooms",
              this.roomId,
              "messages"
            );
            const messagesQuery = query(
              messagesRef,
              orderBy("timestamp", "asc")
            );
            console.log("âœ… ë©”ì‹œì§€ ì¿¼ë¦¬ ìƒì„± ì™„ë£Œ");

            console.log("ğŸ‘‚ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì¤‘...");
            this.unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
              console.log("ğŸ“¨ ë©”ì‹œì§€ ë³€ê²½ ê°ì§€:", {
                size: snapshot.size,
                changes: snapshot.docChanges().length,
              });
              snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                  console.log("â• ìƒˆ ë©”ì‹œì§€ í‘œì‹œ:", change.doc.data());
                  this.displayMessage(change.doc.data());
                }
              });
            });

            console.log("âœ… ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ -", this.roomId);

            // ì‚¬ìš©ì ì˜¨ë¼ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
            console.log("ğŸ‘¤ ì˜¨ë¼ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘...");
            await this.updateOnlineStatus(true);
            console.log("âœ… ì˜¨ë¼ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ");

            // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì˜¤í”„ë¼ì¸ ìƒíƒœë¡œ ë³€ê²½ (í•œ ë²ˆë§Œ ë“±ë¡)
            if (!this.beforeUnloadRegistered) {
              window.addEventListener("beforeunload", () => {
                this.updateOnlineStatus(false);
              });
              this.beforeUnloadRegistered = true;
            }

            console.log("ğŸ‰ joinRoom ì™„ë£Œ:", this.roomId);
          } catch (error) {
            console.error("âŒ ë°© ì°¸ê°€ ì˜¤ë¥˜:", error);
            this.updateConnectionStatus("ì—°ê²° ì˜¤ë¥˜", "error");
          }
        }

        async updateOnlineStatus(isOnline) {
          if (!this.db || !this.currentUser || !this.roomId) return;

          try {
            const { collection, doc, setDoc, deleteDoc, serverTimestamp } =
              window.firebaseModules;

            const userRef = doc(
              this.db,
              "chatRooms",
              this.roomId,
              "onlineUsers",
              this.currentUser.id
            );

            if (isOnline) {
              await setDoc(userRef, {
                name: this.currentUser.name,
                lastSeen: serverTimestamp(),
              });
            } else {
              await deleteDoc(userRef);
            }
          } catch (error) {
            console.error("ì˜¨ë¼ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
          }
        }

        async sendMessage() {
          const content = this.elements.messageInput.value.trim();
          if (!content) return;

          if (!this.db) {
            // ë°ëª¨ ëª¨ë“œì—ì„œëŠ” ë¡œì»¬ì— í‘œì‹œë§Œ
            this.displayMessage({
              content: content,
              user: this.currentUser || { name: "ìµëª…", id: "demo" },
              timestamp: new Date().toISOString(),
            });

            this.elements.messageInput.value = "";
            this.adjustTextareaHeight();
            return;
          }

          try {
            const { collection, addDoc, serverTimestamp } =
              window.firebaseModules;

            const message = {
              content: content,
              user: this.currentUser,
              timestamp: serverTimestamp(),
              roomId: this.roomId,
            };

            const messagesRef = collection(
              this.db,
              "chatRooms",
              this.roomId,
              "messages"
            );
            await addDoc(messagesRef, message);

            this.elements.messageInput.value = "";
            this.adjustTextareaHeight();
            this.elements.sendButton.disabled = true;
          } catch (error) {
            console.error("ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:", error);
            this.displayMessage({
              content: "âš ï¸ ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
              user: { name: "ì‹œìŠ¤í…œ", id: "system" },
              timestamp: new Date().toISOString(),
            });
          }
        }

        displayMessage(message) {
          console.log("ğŸ¨ displayMessage ì‹œì‘:", {
            message,
            currentUser: this.currentUser,
            messagesContainer: !!this.elements.messages,
            messagesChildrenCount: this.elements.messages.children.length,
          });

          // ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ ì œê±°
          const emptyState =
            this.elements.messages.querySelector(".empty-state");
          if (emptyState) {
            console.log("ğŸ—‘ï¸ ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ ì œê±°");
            emptyState.remove();
          }

          const messageElement = document.createElement("div");
          const isOwnMessage = message.user?.id === this.currentUser?.id;

          console.log("ğŸ“ ë©”ì‹œì§€ ìš”ì†Œ ìƒì„±:", {
            isOwnMessage,
            messageUserId: message.user?.id,
            currentUserId: this.currentUser?.id,
            content: message.content,
          });

          messageElement.className = `message ${
            isOwnMessage ? "own" : "other"
          }`;
          messageElement.innerHTML = `
                    <div class="message-header">
                        ${message.user?.name || "ìµëª…"}
                    </div>
                    <div class="message-content">
                        ${this.escapeHtml(message.content)}
                    </div>
                    <div class="message-time">
                        ${this.formatTime(message.timestamp)}
                    </div>
                `;

          console.log("â• ë©”ì‹œì§€ DOMì— ì¶”ê°€ ì¤‘...", {
            elementClassName: messageElement.className,
            elementHTML: messageElement.innerHTML.substring(0, 100) + "...",
          });

          this.elements.messages.appendChild(messageElement);
          this.elements.messages.scrollTop =
            this.elements.messages.scrollHeight;

          console.log("âœ… ë©”ì‹œì§€ í‘œì‹œ ì™„ë£Œ:", {
            totalMessages: this.elements.messages.children.length,
            scrollTop: this.elements.messages.scrollTop,
            scrollHeight: this.elements.messages.scrollHeight,
          });
        }

        handleInputChange(e) {
          const hasContent = e.target.value.trim().length > 0;
          this.elements.sendButton.disabled = !hasContent;
        }

        updateConnectionStatus(message, status) {
          this.elements.connectionStatus.textContent = message;
          this.elements.connectionStatus.className = `connection-status ${status}`;
        }

        adjustTextareaHeight() {
          const textarea = this.elements.messageInput;
          textarea.style.height = "auto";
          textarea.style.height = Math.min(textarea.scrollHeight, 120) + "px";
        }

        escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        formatTime(timestamp) {
          let date;
          if (timestamp && timestamp.toDate) {
            date = timestamp.toDate();
          } else {
            date = new Date(timestamp);
          }
          return date.toLocaleTimeString("ko-KR", {
            hour: "2-digit",
            minute: "2-digit",
          });
        }

        async handleRoomChange() {
          const selectedRoomId = this.elements.roomDropdown.value;
          if (!selectedRoomId) return;

          this.roomId = selectedRoomId;
          await this.joinRoom();
          this.updateProjectInfo();
          this.updateCurrentRoom();
        }

        updateCurrentRoom() {
          if (this.projectInfo) {
            const roomType =
              this.projectInfo.fileType === "figma" ? "Figma" : "ì»´í¬ë„ŒíŠ¸";
            this.elements.roomType.textContent = roomType;
            this.elements.currentRoomName.textContent =
              this.projectInfo.fileName || "ë¬´ì œ í”„ë¡œì íŠ¸";
          }
        }
      }

      // ì•± ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", () => {
        new FigmaFirebaseChatApp();
      });
    </script>
  </body>
</html>
